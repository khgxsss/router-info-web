// src/Dashboard.jsx
import React, { useEffect, useMemo, useRef, useState } from "react";
import { LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, Legend, ResponsiveContainer, ReferenceLine } from "recharts";

// Nginxë¡œ /api í”„ë¡ì‹œ ì‚¬ìš©
const API = "";

// ê° ì§€í‘œì˜ ê¸°ì¤€ê°’(center)ê³¼ í—ˆìš© í¸ì°¨(tol)
const REF = {
  rsrp: {
    center: -100,
    tol: 16,   // -100 + 16 = -84 (ìƒí•œ)
  },
  rsrq: {
    center: -10,
    tol: 4,    // -10 + 4 = -6
  },
  sinr: {
    center: 15,
    tol: 4,    // 15 + 4 = 19
  },
  router_rssi: {
    center: -70,
    tol: 14,   // -70 + 14 = -56
  },
};

/** JSON ë°ì´í„°ì— ëŒ€í•´ ì•ˆì •ì ì¸ í•´ì‹œê°’ ê³„ì‚° (djb2) */
function hashJson(obj) {
  let s;
  try {
    s = JSON.stringify(obj);
  } catch {
    s = String(obj ?? "");
  }
  let h = 5381;
  for (let i = 0; i < s.length; i++) {
    h = ((h << 5) + h) + s.charCodeAt(i); // h * 33 + c
    h |= 0; // 32-bit
  }
  return h >>> 0; // unsigned
}

export default function Dashboard({ user, onLogout }) {
  const [devices, setDevices] = useState([]);
  const [msisdn, setMsisdn] = useState("");
  const [tab, setTab] = useState("chart"); // 'chart' | 'table'

  // --- ê·¸ë˜í”„ ë°ì´í„° ---
  const [days, setDays] = useState(7);
  const [chartMode, setChartMode] = useState("recent"); // 'recent' | 'range'
  const [chartStart, setChartStart] = useState(() => todayOffset(-7));
  const [chartEnd, setChartEnd] = useState(() => todayOffset(0));
  const [agg, setAgg] = useState("all"); // 'daily' | 'all'
  const [daily, setDaily] = useState([]);

  // --- ìƒì„¸ í‘œ ë°ì´í„° ---
  const [start, setStart] = useState(() => todayOffset(-7));
  const [end, setEnd] = useState(() => todayOffset(0));
  const [rows, setRows] = useState([]);
  const [page, setPage] = useState(1);
  const [total, setTotal] = useState(0);
  const pageSize = 200;

  // ì •ë ¬(ìµœì‹ â†”ì˜¤ë˜ëœ)
  const [order, setOrder] = useState("desc"); // 'desc' = ìµœì‹ ë¨¼ì €

  // --- ìë™ ìƒˆë¡œê³ ì¹¨ ---
  const [autoRefresh, setAutoRefresh] = useState(false);
  const [refreshMs, setRefreshMs] = useState(60000); // 60s ê¸°ë³¸
  const [lastUpdated, setLastUpdated] = useState(null);

  // fetch ì·¨ì†Œìš©
  const chartAbort = useRef(null);
  const tableAbort = useRef(null);

  // ì´ì „ í•´ì‹œ ì €ì¥ìš©
  const dailyHashRef = useRef(null);
  const tableHashRef = useRef(null);
  const totalRef = useRef(total);

  // íœ´ë©´ ì—¬ë¶€
  const [showDormant, setShowDormant] = useState(false);

  // device ì´ë¦„ë°”ê¾¼ ë’¤ ë“œë¡­ë‹¤ìš´ ë‹‰ë„¤ì„ ìµœì‹ í™”
  async function loadDevices(selectMsisdn = null) {
    const url = `${API}/api/msisdns?include_dormant=${showDormant ? 1 : 0}`;
    const r = await fetch(url);
    const d = await r.json();
    const list = d.devices || [];
    setDevices(list);

    if (selectMsisdn) setMsisdn(selectMsisdn);
    else if (!msisdn && list.length) setMsisdn(list[0].msisdn);
  }

  useEffect(() => {
    loadDevices(msisdn || null);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [showDormant]);

  // ë””ë°”ì´ìŠ¤ ëª©ë¡ 1íšŒ ë¡œë“œ
  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        if (!mounted) return;
        await loadDevices(null);
      } catch {}
    })();
    return () => { mounted = false; };
  }, []);

  // ê°œë³„ fetch í•¨ìˆ˜ (ë³€ê²½ ì‹œì—ë§Œ ìƒíƒœ ì—…ë°ì´íŠ¸)
  const fetchChart = async (force = false) => {
    if (!msisdn) return false;
    chartAbort.current?.abort?.();
    const ac = new AbortController();
    chartAbort.current = ac;
    try {
      let url;
      if (chartMode === "recent") {
        // âœ… ê¸°ì¡´: ìµœê·¼ Nì¼
        if (agg === "daily") {
          url = `${API}/api/metrics/daily_avg?msisdn=${encodeURIComponent(msisdn)}&days=${days}`;
        } else {
          url = `${API}/api/metrics/raw?msisdn=${encodeURIComponent(msisdn)}&days=${days}`;
        }
      } else {
        // âœ… ë‚ ì§œ ì§€ì • ëª¨ë“œ: start/end ì‚¬ìš©
        if (!chartStart || !chartEnd) return false;
        const qs = `msisdn=${encodeURIComponent(msisdn)}&start=${encodeURIComponent(chartStart)}&end=${encodeURIComponent(chartEnd)}`;
        if (agg === "daily") {
          url = `${API}/api/metrics/daily_avg?${qs}`;
        } else {
          url = `${API}/api/metrics/raw?${qs}`;
        }
      }
      const r = await fetch(url, { signal: ac.signal });
      const d = await r.json();
      const data = d.data || [];
      const h = hashJson({ agg, chartMode, chartStart, chartEnd, data });// ëª¨ë“œ í¬í•¨í•˜ì—¬ í•´ì‹œ
      if (force || h !== dailyHashRef.current) {
        dailyHashRef.current = h;
        setDaily(data);
        return true;
      }
    } catch (_) {}
    return false; // ë³€ê²½ ì—†ìŒ
  };

  const fetchTable = async (force = false) => {
    if (!msisdn || !start || !end) return false;
    tableAbort.current?.abort?.();
    const ac = new AbortController();
    tableAbort.current = ac;
    try {
      const r = await fetch(
        `${API}/api/records?msisdn=${encodeURIComponent(msisdn)}&start=${encodeURIComponent(
          start
        )}&end=${encodeURIComponent(end)}&page=${page}&page_size=${pageSize}&order=${order}`,
        { signal: ac.signal }
      );
      const d = await r.json();
      const newRows = d.rows || [];
      const newTotal = d.total || 0;
      const h = hashJson(newRows);

      const changed = force || h !== tableHashRef.current || newTotal !== totalRef.current;
      if (changed) {
        tableHashRef.current = h;
        totalRef.current = newTotal;
        setRows(newRows);
        setTotal(newTotal);
        return true; // ê°•ì œ ë˜ëŠ” ë³€ê²½ë¨
      }
    } catch (_) {}
    return false; // ë³€ê²½ ì—†ìŒ
  };

  async function handleEditAlias() {
    if (!msisdn) return;
    const current = devices.find(d => d.msisdn === msisdn)?.alias || "";
    const next = window.prompt("ì´ ê¸°ê¸°ì˜ ë³„ì¹­ì„ ì…ë ¥í•˜ì„¸ìš” (ë¹„ìš°ë©´ ì œê±°):", current);
    if (next === null) return; // ì·¨ì†Œ
  
    try {
      const r = await fetch(`${API}/api/devices/alias`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ msisdn, alias: next })
      });
      const j = await r.json();
      if (!r.ok || !j.ok) throw new Error(j.detail || "save failed");
  
      // ë¡œì»¬ ìƒíƒœ ì¦‰ì‹œ ê°±ì‹ (ë“œë¡­ë‹¤ìš´ ë¼ë²¨ ë°˜ì˜) x => ì„œë²„ì—ì„œ ë¡œë“œë””ë°”ì´ìŠ¤ë¡œ ë³€ê²½ 2025.12.16 dhkim
      // setDevices(prev => sortDevices(
      //   prev.map(d => d.msisdn === msisdn ? { ...d, alias: j.alias || null } : d)
      // ));
      await loadDevices(msisdn);
      
      // í† ìŠ¤íŠ¸ ëŒ€ì‹  alert ê°„ë‹¨íˆ
      // alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (e) {
      alert("ë³„ì¹­ ì €ì¥ ì‹¤íŒ¨: " + (e?.message || e));
    }
  }  

  async function handleDeleteDevice() {
    if (!msisdn) return;
    const dev = devices.find(d => d.msisdn === msisdn);
    const label = dev?.alias ? `${msisdn} (${dev.alias})` : msisdn;
    const ok = window.confirm(`ì •ë§ë¡œ ê¸°ê¸° '${label}' ì„(ë¥¼) ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?\n(ì£¼ì˜: ìƒˆ ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ë“±ë¡ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤)`);
    if (!ok) return;
  
    try {
      const url = `${API}/api/devices?msisdn=${encodeURIComponent(msisdn)}`;
      const r = await fetch(url, { method: "DELETE" });
      const j = await r.json();
      if (!r.ok || !j.ok) throw new Error(j.detail || "delete failed");
  
      // ë¡œì»¬ ëª©ë¡ì—ì„œ ì œê±°
      setDevices(prev => prev.filter(d => d.msisdn !== msisdn));
  
      // í˜„ì¬ ì„ íƒì´ ì‚­ì œëœ ê¸°ê¸°ë¼ë©´, ë‹¤ë¥¸ ê¸°ê¸°ë¡œ ìë™ ì „í™˜
      setMsisdn(prev => {
        if (prev !== msisdn) return prev;
        const next = (devices.filter(d => d.msisdn !== msisdn)[0]?.msisdn) || "";
        return next;
      });
  
      // í‘œ/ê·¸ë˜í”„ ë¦¬ì…‹
      setRows([]); setTotal(0); setDaily([]);
    } catch (e) {
      alert("ê¸°ê¸° ì‚­ì œ ì‹¤íŒ¨: " + (e?.message || e));
    }
  }

  function sortDevices(list) {
    return [...list].sort((a, b) => {
      const an = (a.alias || "").trim();
      const bn = (b.alias || "").trim();
      const hasA = an.length > 0;
      const hasB = bn.length > 0;
      if (hasA && hasB) return an.localeCompare(bn, "ko-KR"); // ë‹‰ë„¤ì„ë¼ë¦¬ ì‚¬ì „ìˆœ
      if (hasA) return -1;  // ë‹‰ë„¤ì„ ìˆëŠ” ê¸°ê¸° ë¨¼ì €
      if (hasB) return 1;
      return a.msisdn.localeCompare(b.msisdn); // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ msisdn ì‚¬ì „ìˆœ
    });
  }  

  // ìµœì´ˆ/ì˜ì¡´ì„± ë³€ê²½ ì‹œ ì¦‰ì‹œ ë¡œë“œ
  useEffect(() => {
    if (!msisdn) return;
    (async () => {
      const changed = await fetchChart();
      if (changed) setLastUpdated(new Date());
    })();
  }, [msisdn, days, agg, chartMode, chartStart, chartEnd]);

  useEffect(() => {
    if (!msisdn) return;
    (async () => {
      const changed = await fetchTable();
      if (changed) setLastUpdated(new Date());
    })();
  }, [msisdn, start, end, page, order]);

  // ìë™ ìƒˆë¡œê³ ì¹¨: í˜„ì¬ íƒ­ë§Œ ê°±ì‹  + íƒ­ ìˆ¨ê¹€ ì‹œ ì¼ì‹œì •ì§€ + ë³€ê²½ ì‹œì—ë§Œ lastUpdated ê°±ì‹ 
  useEffect(() => {
    if (!autoRefresh) return;

    const tick = async () => {
      if (document.visibilityState === "hidden") return; // ìˆ¨ê¹€ì´ë©´ ìŠ¤í‚µ
      let changed = false;
      if (tab === "chart") {
        changed = await fetchChart();
      } else {
        changed = await fetchTable();
      }
      if (changed) setLastUpdated(new Date());
    };

    // ì¦‰ì‹œ 1íšŒ ì‹¤í–‰ í›„ interval ì‹œì‘
    tick();
    const id = setInterval(tick, refreshMs);
    return () => clearInterval(id);
  }, [autoRefresh, refreshMs, tab, msisdn, days, agg, chartMode, chartStart, chartEnd, start, end, page, order]);



  const isDailyEmpty = useMemo(() => (daily?.length || 0) === 0, [daily]);
  const totalPages = Math.max(1, Math.ceil(total / pageSize));

  return (
    <div style={{ fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, sans-serif", padding: 16 }}>
      {/* ìƒë‹¨ ë°” */}
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 12, flexWrap: "wrap" }}>
        <h1 style={{ margin: 0 }}>Router Info Dashboard</h1>
        {user ? <span style={{ opacity: 0.9 }}>{user} ë‹˜</span> : null}
        {onLogout ? (
          <button
            onClick={onLogout}
            style={{
              marginLeft: "auto",
              background: "#111827",
              color: "#fff",
              border: "1px solid #111827",
              borderRadius: 6,
              padding: "6px 10px",
              cursor: "pointer",
            }}
          >
            ë¡œê·¸ì•„ì›ƒ
          </button>
        ) : null}
      </div>

      {/* ì»¨íŠ¸ë¡¤ ë°” */}
      <div
        style={{
          display: "flex",
          gap: 12,
          alignItems: "center",
          marginBottom: 16,
          flexWrap: "wrap",
          background: "#f8fafc",
          padding: 12,
          borderRadius: 8,
          border: "1px solid #e5e7eb",
        }}
      >
        <label>
          ê¸°ê¸°(msisdn):{" "}
          <select
            value={msisdn}
            onChange={(e) => {
              setMsisdn(e.target.value);
              setPage(1);
            }}
          >
            {devices.map((d) => {
              const label = `${d.msisdn}${d.alias ? ` (${d.alias})` : ""}`;
              // ìµœê·¼ 24ì‹œê°„ ë°ì´í„° ì—†ëŠ” ê¸°ê¸°ë§Œ íšŒìƒ‰
              const style = d.has_recent
                ? { color: "#111827" } // í‰ì†Œ ì§„í•œ ê¸€ì
                : { color: "#9ca3af" }; // íšŒìƒ‰ (ë¹„í™œì„±ì²˜ëŸ¼ ë³´ì´ê²Œ)
              return (
                <option key={d.msisdn} value={d.msisdn} style={style}>
                  {label}
                </option>
              );
            })}
          </select>
        </label>

        <div style={{ display: "flex", gap: 8 }}>
          <button onClick={() => setTab("chart")} style={tabBtn(tab === "chart")}>
            ê·¸ë˜í”„
          </button>
          <button onClick={() => setTab("table")} style={tabBtn(tab === "table")}>
            ìƒì„¸
          </button>
        </div>

        <div style={{ width: 1, height: 24, background: "#e5e7eb" }} />

        {/* ìë™ ìƒˆë¡œê³ ì¹¨ ì»¨íŠ¸ë¡¤ */}
        <label style={{ display: "flex", alignItems: "center", gap: 6 }}>
          <input type="checkbox" checked={autoRefresh} onChange={(e) => setAutoRefresh(e.target.checked)} />
          ìë™ ìƒˆë¡œê³ ì¹¨
        </label>
        <label>
          ì£¼ê¸°:{" "}
          <select value={refreshMs} onChange={(e) => setRefreshMs(Number(e.target.value))}>
            <option value={10000}>10ì´ˆ</option>
            <option value={15000}>15ì´ˆ</option>
            <option value={30000}>30ì´ˆ</option>
            <option value={60000}>60ì´ˆ</option>
          </select>
        </label>
        <button
          onClick={async () => {
          if (tab === "chart") {
            await fetchChart(true);   // ê°•ì œ ê°±ì‹ 
          } else {
            await fetchTable(true);   // ê°•ì œ ê°±ì‹ 
          }
          setLastUpdated(new Date()); // í•´ì‹œì™€ ë¬´ê´€í•˜ê²Œ ê°±ì‹  ì‹œê°„ í‘œê¸°
          }}
          style={{
            padding: "6px 10px",
            borderRadius: 8,
            border: "1px solid #2563eb",
            background: "#2563eb",
            color: "#fff",
            fontWeight: 600,
            cursor: "pointer"
          }}
          title="ì§€ê¸ˆ ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨"
        >
          ì§€ê¸ˆ ìƒˆë¡œê³ ì¹¨
        </button>

        <button onClick={handleEditAlias} style={{ padding:"8px 12px", borderRadius:8, border:"1px solid #111", background:"#fff", cursor:"pointer" }}>
          ê¸°ê¸°ë³„ëª…
        </button>
        <button
          className="btn-danger"
          onClick={handleDeleteDevice}
          title="í˜„ì¬ ì„ íƒí•œ ê¸°ê¸°ë¥¼ ëª©ë¡ì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤"
        >
          ê¸°ê¸°ì‚­ì œ
        </button>
        <label style={{ marginLeft: 12 }}>
          <input
            type="checkbox"
            checked={showDormant}
            onChange={(e) => setShowDormant(e.target.checked)}
          />
          {" "}íœ´ë©´ ê¸°ê¸° ë³´ê¸°
        </label>

        {lastUpdated && (
          <span style={{ marginLeft: "auto", fontSize: 12, color: "#6b7280" }}>
            ë§ˆì§€ë§‰ ê°±ì‹ : {fmtTime(lastUpdated)}
          </span>
        )}
      </div>

      {/* ë³¸ë¬¸ */}
      {tab === "chart" ? (
        <>
          <div
            style={{
              marginBottom: 12,
              display: "flex",
              gap: 8,
              alignItems: "center",
              flexWrap: "wrap",
            }}
          >
            <span>ë°ì´í„° êµ¬ê°„ ë³´ê¸°:</span>
            <select
              value={chartMode}
              onChange={(e) => {
                const v = e.target.value;
                setChartMode(v);
                // ëª¨ë“œ ë°”ê¿€ ë•Œ í˜ì´ì§€ ë¦¬ì…‹ ëŠë‚Œìœ¼ë¡œ ì°¨íŠ¸ë„ ìƒˆë¡œê³ ì¹¨
              }}
            >
              <option value="recent">ìµœê·¼</option>
              <option value="range">ë‚ ì§œ ì§€ì •</option>
            </select>

            {chartMode === "recent" ? (
              <>
                <span>ìµœê·¼</span>
                <select value={days} onChange={(e) => setDays(Number(e.target.value))}>
                  {[7, 14, 30].map((n) => (
                    <option key={n} value={n}>
                      {n}
                    </option>
                  ))}
                </select>
                <span>ì¼</span>
              </>
            ) : (
              <>
                <span>ê¸°ê°„</span>
                <input
                  type="date"
                  value={chartStart}
                  onChange={(e) => setChartStart(e.target.value)}
                />
                <span>~</span>
                <input
                  type="date"
                  value={chartEnd}
                  onChange={(e) => setChartEnd(e.target.value)}
                />
              </>
            )}

            <span>/</span>
            <select value={agg} onChange={(e) => setAgg(e.target.value)}>
              <option value="daily">ì¼ë³„ í‰ê· </option>
              <option value="all">ëª¨ë“  ë°ì´í„°</option>
            </select>
          </div>

          {isDailyEmpty ? (
            <div style={{ padding: 12, color: "#666" }}>ìµœê·¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„ì„ ëŠ˜ë ¤ ë³´ì„¸ìš”.</div>
          ) : (
            <>
              <MetricChart title="RSRP (dBm)" data={daily} dataKey={agg === "daily" ? "rsrp_avg" : "rsrp"} metric="rsrp" xKey={agg === "daily" ? "d" : "ts"} />
              <MetricChart title="RSRQ (dB)"  data={daily} dataKey={agg === "daily" ? "rsrq_avg" : "rsrq"} metric="rsrq" xKey={agg === "daily" ? "d" : "ts"} />
              <MetricChart title="SINR (dB)"  data={daily} dataKey={agg === "daily" ? "sinr_avg" : "sinr"} metric="sinr" xKey={agg === "daily" ? "d" : "ts"} />
              <MetricChart title="Router RSSI (dBm)" data={daily} dataKey={agg === "daily" ? "router_rssi_avg" : "router_rssi"} metric="router_rssi" xKey={agg === "daily" ? "d" : "ts"} />
            </>
          )}
        </>
      ) : (
        <>
          <div style={{ display: "flex", gap: 12, marginBottom: 12, alignItems: "center", flexWrap: "wrap" }}>
            <div>
              ì‹œì‘ì¼:{" "}
              <input
                type="date"
                value={start}
                onChange={(e) => {
                  setStart(e.target.value);
                  setPage(1);
                }}
              />
            </div>
            <div>
              ì¢…ë£Œì¼:{" "}
              <input
                type="date"
                value={end}
                onChange={(e) => {
                  setEnd(e.target.value);
                  setPage(1);
                }}
              />
            </div>

            {/* ì •ë ¬ í† ê¸€ */}
            <button
              onClick={() => {
                setOrder((prev) => (prev === "desc" ? "asc" : "desc"));
                setPage(1);
              }}
              style={{
                padding: "8px 12px",
                borderRadius: 8,
                border: "1px solid #111827",
                background: "#fff",
                color: "#111827",
                fontWeight: 600,
                cursor: "pointer",
              }}
              title="ì •ë ¬ ìˆœì„œ í† ê¸€ (ìµœì‹ â†”ì˜¤ë˜ëœ)"
            >
              ì •ë ¬: {order === "desc" ? "ìµœì‹  â†’ ì˜¤ë˜ëœ" : "ì˜¤ë˜ëœ â†’ ìµœì‹ "}
            </button>

            {/* CSV ë‹¤ìš´ë¡œë“œ (ì •ë ¬ ë°˜ì˜) */}
            <button
              onClick={() => {
                if (!msisdn || !start || !end) return;
                const url = `${API}/api/records/csv?msisdn=${encodeURIComponent(
                  msisdn
                )}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&order=${order}`;
                window.open(url, "_blank");
              }}
              style={{ padding: "8px 12px", borderRadius: 8, border: "1px solid #2563eb", background: "#2563eb", color: "#fff", fontWeight: 600, cursor: "pointer" }}
            >
              CSV ë‹¤ìš´ë¡œë“œ
            </button>
          </div>

          <div
            style={{
              overflow: "auto",
              border: "1px solid #cbd5e1",
              borderRadius: 10,
              maxHeight: 1000,
              boxShadow: "0 1px 2px rgba(0,0,0,0.06)",
            }}
          >
            <table style={{ borderCollapse: "collapse", width: "100%", fontSize: 13 }}>
              <thead>
                <tr>{headers.map((h) => <th key={h} style={th}>{h}</th>)}</tr>
              </thead>
              <tbody>
                {rows.length === 0 ? (
                  <tr>
                    <td colSpan={headers.length} style={{ padding: 16, textAlign: "center", color: "#6b7280" }}>
                      í•´ë‹¹ ê¸°ê°„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.
                    </td>
                  </tr>
                ) : (
                  rows.map((r, idx) => {
                    const zebra = idx % 2 === 0 ? "#ffffff" : "#f9fafb";
                    return (
                      <tr
                        key={r.id}
                        style={{ background: zebra, transition: "background 0.15s ease" }}
                        onMouseEnter={(e) => (e.currentTarget.style.background = "#eef2ff")}
                        onMouseLeave={(e) => (e.currentTarget.style.background = zebra)}
                      >
                        {headers.map((h) => (
                          <td key={h} style={td}>
                            {fmt(r, h)}
                          </td>
                        ))}
                      </tr>
                    );
                  })
                )}
              </tbody>
            </table>
          </div>

          <div style={{ marginTop: 8, display: "flex", gap: 8, alignItems: "center" }}>
            <button disabled={page <= 1} onClick={() => setPage((p) => p - 1)}>
              ì´ì „
            </button>
            <span>
              {page} / {Math.max(1, Math.ceil(total / pageSize))} (ì´ {total}ê±´)
            </span>
            <button disabled={page >= Math.max(1, Math.ceil(total / pageSize))} onClick={() => setPage((p) => p + 1)}>
              ë‹¤ìŒ
            </button>
          </div>
        </>
      )}
    </div>
  );
}

/** ê°œë³„ ì§€í‘œ ì°¨íŠ¸ */
/** ê°œë³„ ì§€í‘œ ì°¨íŠ¸ */
function MetricChart({ title, data, dataKey, xKey = "d", metric }) {
  const hideXAxisLabels = xKey === "ts";
  // ê¸°ì¤€/ìƒí•œ ì •ë³´
  const ref = REF[metric];

  // ê¸°ì¤€ì„ ì„ ì°¨íŠ¸ ì •ì¤‘ì•™ì— ì˜¤ë„ë¡ Y ë„ë©”ì¸ì„ ê¸°ì¤€ê°’ ì¤‘ì‹¬ ëŒ€ì¹­ìœ¼ë¡œ ì„¤ì •
  let yDomain = undefined;
  if (ref) {
    const vals = (data || [])
      .map((d) => d?.[dataKey])
      .filter((v) => typeof v === "number" && !Number.isNaN(v));
    if (vals.length) {
      const dataMin = Math.min(...vals);
      const dataMax = Math.max(...vals);
      const center = ref.center;
      const boundaryMax = center + ref.tol;      // ìƒí•œ
      const boundaryMin = center - ref.tol;      // ì´ê±´ ë„ë©”ì¸ ê³„ì‚°ìš©(ëŒ€ì¹­)

      const delta = Math.max(
        Math.abs(dataMax - center),
        Math.abs(center - dataMin),
        Math.abs(boundaryMax - center),
        Math.abs(center - boundaryMin)
      );
      const pad = Math.max(delta * 0.05, 1);
      yDomain = [center - (delta + pad), center + (delta + pad)];
    } else {
      // ë°ì´í„° ì—†ìœ¼ë©´ ê¸°ì¤€Â±tolë§Œ í¬í•¨
      yDomain = [ref.center - ref.tol, ref.center + ref.tol];
    }
  }

  return (
    <div
      style={{
        height: 240,
        marginBottom: 24,
        border: "1px solid #eee",
        borderRadius: 8,
        padding: 12,
      }}
    >
      <div style={{ marginBottom: 6, fontWeight: 600 }}>{title}</div>
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={data}>
          <CartesianGrid strokeDasharray="4 4" />
          <XAxis
            dataKey={xKey}
            tick={hideXAxisLabels ? false : true}
            axisLine={!hideXAxisLabels}
            tickLine={!hideXAxisLabels}
          />
          <YAxis domain={yDomain} />
          <Tooltip formatter={(value) => {
            if (typeof value === "number") {
              return Number(value.toFixed(3)); // ì†Œìˆ˜ì  3ìë¦¬ ë°˜ì˜¬ë¦¼
            }
            return value;
          }} />
          <Legend
            wrapperStyle={{
              fontWeight: 500,
              fontSize: 13,
              color: "#111827",
              paddingBottom: 20,
            }}
          />
          {/* ê¸°ì¤€ì„ /ìƒí•œì„ ë§Œ í‘œì‹œ */}
          {ref && (
            <>
              {/* ê¸°ì¤€ê°’: ì—°ë‘ìƒ‰ êµµì€ ì„  */}
              <ReferenceLine y={ref.center} stroke="#32CD32" strokeWidth={3} />
              {/* ìƒí•œ: ë¹¨ê°„ ì–‡ì€ ì ì„  */}
              <ReferenceLine
                y={ref.center + ref.tol}
                stroke="#ef4444"
                strokeWidth={1}
                strokeDasharray="4 4"
              />
              {/* ğŸ”» í•˜í•œì„ ì€ ë” ì´ìƒ ì—†ìŒ */}
            </>
          )}
          {/* ì‹¤ì œ ë°ì´í„° ë¼ì¸ */}
          <Line type="monotone" dataKey={dataKey} dot={false} />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}


/* ---------- ìœ í‹¸/ìŠ¤íƒ€ì¼ ---------- */

const headers = [
  "ts_kst",
  "datetime_str",
  "system",
  "plmn",
  "band",
  "earfcn_dl",
  "earfcn_ul",
  "bandwidth",
  "cell_id",
  "pci",
  "drx",
  "rsrp",
  "rsrq",
  "rssi",
  "tac",
  "sinr",
  "rrc_st",
  "emc_st",
  "scell_band",
  "scell_bw",
  "scell_status",
  "latitude",
  "longitude",
  "ip_v4",
  "dl_mbps",
  "ul_mbps",
  "router_rssi",
  "router_temp_c",
];

function fmt(row, key) {
  return row?.[key] ?? "";
}
function todayOffset(n) {
  const d = new Date();
  d.setDate(d.getDate() + n);
  return d.toISOString().slice(0, 10);
}
function fmtTime(d) {
  const pad = (x) => String(x).padStart(2, "0");
  return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
}
function tabBtn(active) {
  return {
    padding: "8px 14px",
    borderRadius: 8,
    border: active ? "2px solid #2b6cb0" : "1px solid #999",
    background: active ? "#2b6cb0" : "#f7f7f7",
    color: active ? "#fff" : "#333",
    fontWeight: active ? 600 : 400,
    cursor: "pointer",
    transition: "all 0.2s ease-in-out",
  };
}

const th = {
  position: "sticky",
  top: 0,
  background: "#1f2937",
  color: "#ffffff",
  borderBottom: "1px solid #0f172a",
  padding: "10px 12px",
  textAlign: "left",
  fontWeight: 700,
  fontSize: 13,
  letterSpacing: 0.2,
};

const td = {
  padding: "9px 12px",
  borderBottom: "1px solid #e5e7eb",
  color: "#111827",
  fontSize: 13,
};
